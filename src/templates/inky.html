<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.name }}</title>
    <script>
        (function() {
            const theme = localStorage.getItem('inkypi-theme') || 
                         (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
        
        // Track last modified headers for both images independently
        let lastModified1 = null;
        let lastModified2 = null;
        const refreshIntervalMs = 3 * 1000;

        async function fetchImageData(url, currentLastModified, selector) {
            const img = document.querySelector(selector);
            if (!img) return currentLastModified;

            try {
                const headers = {};
                if (currentLastModified) {
                    headers['If-Modified-Since'] = currentLastModified;
                }

                const response = await fetch(url, { headers });
                
                if (response.status === 304) {
                    return currentLastModified;
                }

                if (!response.ok) {
                    console.error('Failed to fetch image:', response.status);
                    return currentLastModified;
                }

                const blob = await response.blob();
                const objectUrl = URL.createObjectURL(blob);
                
                img.src = objectUrl;
                return response.headers.get('Last-Modified');
            } catch (error) {
                console.error('Error refreshing image:', error);
                return currentLastModified;
            }
        }

        async function refreshImage() {
            // TARGET BY ID: This ensures we update the correct image regardless of class
            lastModified1 = await fetchImageData('{{ url_for("main.get_current_image") }}', lastModified1, '#inky-display-1');
            lastModified2 = await fetchImageData('{{ url_for("main.get_current_image_2") }}', lastModified2, '#inky-display-2');
        }

        document.addEventListener('DOMContentLoaded', function() {
            refreshImage();
            setInterval(refreshImage, refreshIntervalMs);
        });
    </script>
</head>
<link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
<script src="{{ url_for('static', filename='scripts/image_modal.js') }}"></script>
<body>
    <script src="{{ url_for('static', filename='scripts/dark_mode.js') }}"></script>
    <div class="frame">
        <header class="header">
            <h1>{{ config.name }}</h1>
            <button class="settings-button dark-mode-toggle" title="Toggle Dark Mode" aria-label="Toggle Dark Mode"></button>
            <a href="{{ url_for('playlist.playlists') }}" class="settings-button">
                <img src="{{ url_for('static', filename='icons/playlist.png') }}" title="Playlists" alt="playlists icon" class="icon-image">
            </a>
            <a href="{{ url_for('settings.settings_page') }}" class="settings-button">
                <img src="{{ url_for('static', filename='icons/settings.png') }}" title="Settings" alt="settings icon" class="icon-image">
            </a>
        </header>

        <div class="image-container">
            <img id="inky-display-1" src="{{ url_for('static', filename='images/current_image.png') }}" alt="Current Image">
        </div>

        <div style="height: 20px;"></div>

        <div class="image-container">
            <img id="inky-display-2" src="{{ url_for('static', filename='images/current_image2.png') }}" alt="Current Image 2">
        </div>

        <div class="separator"></div>
        <h2 class="plugins-title">Plugins</h2>
        <div class="button-grid">
            {% for plugin in plugins %}
            <a href="{{ url_for('plugin.plugin_page', plugin_id=plugin.id) }}" class="icon-button" title="{{ plugin.display_name }}" >
                <img src="{{ url_for('plugin.image', plugin_id=plugin.id, filename='icon.png') }}" alt="{{ plugin.display_name }} icon" class="icon-image">
            </a>
            {% endfor %}
        </div>
    </div>
</body>
</html>